# 버퍼LOCK

> https://velog.io/@yooha9621/1-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%AA%A8%EB%8D%B8%EB%A7%81%EC%9D%98-%EC%9D%B4%ED%95%B42.%EB%B2%84%ED%8D%BC-Lock

* 하나의 cache buffers chains Latch를 통해 여러 해시 체인이 보호 되고 있다.
* 동시에 하나의 버퍼 블록을 접근 할 경우 정합성 문제가 발생할 수 있어 Latch를 통해 직렬화를 수행한다.
* 버퍼 블록을 찾으면 버퍼 Lock 설정 후 Latch를 해제하고 버퍼 Lock을 못 얻으면 Lock을 획득할 때까지 대기한다.

## 버퍼 LOCK 필요성

1. <b>데이터 일관성 보장:</b> 여러 개의 세션이 동시에 동일한 데이터 블록을 변경하려고 할 때, 버퍼 락을 사용하여 한 세션의 변경 작업이 완료될 때까지 다른 세션의 변경을 차단함으로써 데이터의 일관성을 유지할 수 있습니다.

1. <b>동시성 제어:</b> 여러 세션이 동시에 동일한 데이터 블록에 접근하려고 할 때, 버퍼 락을 사용하여 동시성 문제를 해결할 수 있습니다. 데이터 블록에 버퍼 락이 설정되면 다른 세션은 해당 블록에 접근할 수 없게 됩니다.

1. <b>병행성 제어:</b> 동시성을 최대화하면서도 데이터의 일관성을 유지하기 위해 버퍼 락을 사용할 수 있습니다. 버퍼 락은 필요한 경우만 설정되며, 데이터 액세스가 필요 없는 경우에는 다른 세션이 동시에 접근할 수 있도록 합니다.

1. <b>데이터 무결성 유지:</b> 데이터의 무결성을 보호하기 위해 버퍼 락을 사용할 수 있습니다. 버퍼 락을 통해 정확한 데이터 변경 순서를 보장하여 데이터 무결성 위반을 방지할 수 있습니다.

1. <b>Deadlock 방지:</b> 버퍼 락은 여러 세션 간의 경쟁 상황에서 데드락을 방지하는 데 도움을 줄 수 있습니다. 데드락은 서로 다른 세션 간의 순환 대기 상태로 인해 발생하는데, 버퍼 락을 적절히 사용하면 이를 예방하거나 해결할 수 있습니다.

## 버퍼 LOCK 상태
1. Share 모드 Lock
    * 버퍼 내용을 읽기만 할 때 사용한다.
1. Exclusive 모드 Lock
    * 버퍼 내용을 변경할 때 사용한다.
    * buffer busy waits 대기 이벤트
        * 버퍼가 Exclusive모드로 점유되어 있다면 버퍼 헤더의 Lock 대기자 목록(Waiter List)에 등록 후 래치를 해제한다.
        * 선행 버퍼 Lock이 해제되면 그 때 버퍼 Lock을 획득할 수 있다.

## 버퍼 LOCK 획득/해제 과정

버퍼 락(lock): 데이터 블록에 대한 접근을 제어합니다. 여러 세션이 동시에 동일한 데이터 블록을 수정하려 할 때 충돌을 방지하고 데이터 일관성을 유지하기 위해 사용됩니다. 버퍼 락은 데이터 블록에 대한 변경 작업을 위한 허가를 획득한 세션에게 제공됩니다.

체인 래치(chain latch): 버퍼 블록들을 관리하기 위한 메커니즘으로, 여러 버퍼 블록을 하나의 체인으로 연결하여 관리합니다. 데이터 블록의 래치는 해당 블록에 대한 변경 작업을 진행하는 동안에만 획득됩니다. 이를 통해 여러 세션이 동시에 데이터 블록에 변경을 가하는 것을 방지하고 데이터 일관성을 보장합니다.

1. 세션이 특정 데이터 블록을 수정하기 위해 접근하려고 합니다.
2. 데이터베이스 관리 시스템은 해당 데이터 블록의 버퍼 락을 획득하기 위해 대기열에 세션을 추가합니다.
3. 이미 락을 획득한 세션이 있는 경우, 새로운 세션은 대기 상태로 전환됩니다.
4. 락을 획득한 세션은 해당 데이터 블록의 내용을 변경합니다.
5. 변경 작업을 마친 세션은 버퍼 락을 해제하며, 다른 세션들이 해당 데이터 블록에 접근할 수 있도록 합니다.
* 위의 과정에서 버퍼 락 해제 후에 래치를 다시 획득하지 않습니다. 대신 다른 세션이 해당 데이터 블록에 접근하려고 할 때 래치를 획득하게 됩니다. 이렇게 함으로써 데이터 블록에 대한 변경과 일관성 유지가 조율됩니다.


## 버퍼 핸들
<h3><b>버퍼핸들</b></h3>
<ul>
	<li>버퍼헤더에 Pin을 설정하려고 사용하는 오브젝트를 일컬음.</li>
	<li>버퍼Pin = 버퍼lock : 자신이 해당 버퍼를 사용중임을 표시하는 것.</li>
	<li>버퍼핸들을 얻어 버퍼헤더에 있는 소유자 목록에 연결시키는 방식으로 Pin을 설정한다.</li>
	<li>버퍼핸들을 얻으려면 cache buffer handles 래치가 필요하다.</li>
	<li>오라클은 각 프로세스마다 _db_handles_cached 개수만큼 버퍼 핸들을 미리 할당해주며 기본값은 5이다.</li>
</ul>
<h3><b>버퍼 Pining</b></h3>
<ul>
	<li>버퍼를 읽고 나서 버퍼Pin을 즉각 해제하지 않고 데이터베이스 Call이 진행되는 동안 유지하는 기능.</li>
	<li>같은 블록을 반복적으로 읽을 때 래치획득 과정을 생략하기 때문에 논리적 블록읽기 횟수를 획기적으로 줄일 수 있음.</li>
	<li>같은 블록을 재방문할 가능성이 큰 오퍼레이션을 수행할 때만 사용됨.</li>
	<li>하나의 데이터베이스 Call 내에서만 유효함.</li>
</ul>

<h3><b>버퍼 Pin</b></h3>
<p>버퍼 핀은 버퍼 캐시의 데이터 블록을 메모리에 고정시켜 놓는 것을 말합니다. 이로써 해당 데이터 블록은 메모리에 상주하며, 디스크로부터의 반복적인 읽기 작업을 피하고 데이터 액세스 속도를 향상시킵니다. 버퍼 핀을 설정하면 해당 버퍼가 메모리에 상주하고 있으므로, 다른 세션에서의 데이터 변경과 충돌을 방지할 수 있습니다.
</p>

